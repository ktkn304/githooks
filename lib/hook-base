#!/usr/bin/env bash

set -eu

mydir=$(dirname "$0")
basedir="$mydir/../"
name='core'
hook=$(basename "$0")
. "$basedir/lib/common"

load_env "$basedir"

function run_scripts() {
	local path="$1"; shift
	local hook="$1"; shift
	local name=$(basename "$path")

	echo "run: \"$path\""
	if [ "$name" = "all_hooks" ]; then
		"$path" "$hook" "$@"
	else
		"$path" "$@"
	fi
}

echo 'begin: ghooks'
list_apps | while read app || test -n "$app"
do
	has_script=''
	while read script || test -n "$script"
	do
		if [ -z "$has_script" ]; then
			echo "begin: $app"
			has_script="1"
		fi
		
		run_scripts "$script" "$hook" "$@"
	done < <(get_app_hook "$app" "$hook")
	if [ -n "$has_script" ]; then
		echo "done: $app"
	fi
done
echo 'done: ghooks'
